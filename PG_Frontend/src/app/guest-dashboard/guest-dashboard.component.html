<div class="dashboard">
    <nav class="sidebar">
        <h3>Guest</h3>
        <button (click)="switchTab('complaints')" [class.active]="activeTab==='complaints'">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" style="width: 18px; margin-right: 12px;">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
            Complaints
        </button>
        <button (click)="switchTab('profile')" [class.active]="activeTab==='profile'">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" style="width: 18px; margin-right: 12px;">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
            </svg>
            My Profile
        </button>
        <button (click)="switchTab('transactions')" [class.active]="activeTab==='transactions'">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" style="width: 18px; margin-right: 12px;">
                <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
            </svg>
            My Transactions
        </button>
    </nav>

    <main class="content">
        <div *ngIf="profile">
            <div *ngIf="activeTab === 'complaints'">
                <div class="header-action">
                    <h2>Manage Complaints</h2>
                    <button class="action-btn" (click)="openComplaintModal()">+ Raise Complaint</button>
                </div>

                <div class="list">
                    <h3>My Complaints</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th>Status</th>
                                <th>Resolution</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let c of complaints" class="fade-in-row">
                                <td>{{c.createdDate | date:'mediumDate'}}</td>
                                <td style="font-weight: 600; color: #434190;">{{c.type}}</td>
                                <td>
                                    {{c.description}}
                                    <div *ngIf="c.notes" class="supervisor-note">
                                        <strong>Note:</strong> {{c.notes}}
                                    </div>
                                </td>
                                <td>
                                    <span class="status-badge" [class]="'status-' + c.status.toLowerCase()">
                                        {{c.status}}
                                    </span>
                                </td>
                                <td>
                                    <span *ngIf="c.status === 'InProgress' && c.estimatedResolutionDays"
                                        style="font-size: 0.85rem; color: #718096;">
                                        Est: {{c.estimatedResolutionDays}} Day{{c.estimatedResolutionDays > 1 ? 's' :
                                        ''}}
                                    </span>
                                    <div *ngIf="c.status === 'Solved'" style="display: flex; flex-direction: column;">
                                        <span style="color: #48bb78; font-weight: 600;">Resolved</span>
                                        <small style="color: #a0aec0; font-size: 0.75rem;">on {{c.solvedDate |
                                            date:'shortDate'}}</small>
                                    </div>
                                    <span *ngIf="c.status === 'Registered'">-</span>
                                </td>
                                <td>
                                    <button *ngIf="c.status === 'Registered' || c.status === 'InProgress'"
                                        (click)="c.status === 'Registered' ? cancelComplaint(c.id) : null"
                                        [disabled]="c.status !== 'Registered'" class="delete-btn"
                                        [title]="c.status === 'InProgress' ? 'Cannot cancel once management starts working on it' : ''">
                                        Cancel
                                    </button>
                                    <span *ngIf="c.status === 'Solved'">-</span>
                                </td>
                            </tr>
                            <tr *ngIf="complaints.length === 0">
                                <td colspan="6" style="text-align: center; padding: 3rem; color: #718096;">
                                    No complaints found. Raise one if you face any issues!
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Raise Complaint Modal -->
                <div class="modal-overlay" *ngIf="showComplaintModal">
                    <div class="modal-content">
                        <h3>Raise a Complaint</h3>
                        <form [formGroup]="complaintForm" (ngSubmit)="registerComplaint()">
                            <div class="form-group">
                                <label>Complaint Type</label>
                                <select formControlName="type">
                                    <option value="" disabled selected>Select Issue Type</option>
                                    <option *ngFor="let t of complaintTypes" [value]="t">{{t}}</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Description (Max 600 characters)</label>
                                <textarea formControlName="description" placeholder="Describe your problem in detail..."
                                    maxlength="600"></textarea>
                                <small class="char-count"
                                    *ngIf="complaintForm.get('description')?.value">{{complaintForm.get('description')?.value.length}}/600</small>
                            </div>
                            <div class="modal-actions">
                                <button type="button" class="close-btn" (click)="closeComplaintModal()">Cancel</button>
                                <button type="submit" class="action-btn" [disabled]="complaintForm.invalid">Register
                                    Complaint</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div *ngIf="activeTab === 'profile'">
                <div class="header-action">
                    <h2>My Profile</h2>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <span class="stat-label">Room Number</span>
                        <span class="stat-value">{{profile.roomNumber}}</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-label">Rent Amount</span>
                        <span class="stat-value">₹{{profile.rentAmount}}</span>
                    </div>

                    <div class="stat-card">
                        <span class="stat-label">{{ profile.rentType === 'Daily' ? 'Exit Date' :
                            (profile.isInNoticePeriod ? 'Days Left for Exit' : 'Next Due Date') }}</span>
                        <span class="stat-value">
                            <ng-container
                                *ngIf="profile.isInNoticePeriod && profile.rentType !== 'Daily'; else normalDate">
                                {{ getDaysLeftForExit() }} Days
                            </ng-container>
                            <ng-template #normalDate>
                                {{ (profile.rentType === 'Daily' ? profile.endDate : profile.rentDueDate) |
                                date:'mediumDate' }}
                            </ng-template>
                        </span>
                    </div>

                    <div class="stat-card">
                        <span class="stat-label">Status</span>
                        <div style="margin-top: 8px;">
                            <span [ngClass]="profile.user.isActive ? 'status-active-pulse' : 'status-disabled-pulse'">
                                {{profile.user.isActive ? 'Active' : 'Disabled'}}
                            </span>
                        </div>
                    </div>

                </div>

                <div class="profile-details">
                    <div class="detail-section" *ngIf="profile.rentType !== 'Daily'">
                        <h3>Room Details</h3>
                        <p><strong>Advance Amount:</strong> ₹{{profile.advanceAmount}}</p>
                        <p><strong>Joining Date:</strong> {{profile.joiningDate | date}}</p>
                    </div>


                    <div class="detail-section" *ngIf="profile.rentType === 'Daily'">
                        <h3>Stay Type</h3>
                        <p style="font-size: 1.1rem; color: #434190; font-weight: 600;">Daily Basis</p>
                    </div>




                    <div class="detail-section" *ngIf="profile.rentType !== 'Daily'">
                        <h3>Monthly Rent Payment</h3>

                        <!-- When Rent is Due -->
                        <div *ngIf="profile.isRentDue">
                            <p style="color: #e53e3e; font-weight: 600;">Rent Due: ₹{{profile.rentAmount}}</p>
                            <p class="small-text">Due since: {{profile.rentDueDate | date}}</p>
                            <button class="action-btn" (click)="payRent()" style="margin-top: 1rem;">Pay Monthly
                                Rent</button>
                        </div>


                        <!-- When Rent is Paid / Not Due -->
                        <div *ngIf="!profile.isRentDue">
                            <div class="status-badge"
                                style="background: #f0fff4; color: #38a169; border: 1px solid #c6f6d5; margin-top: 10px;">

                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                    style="width: 16px; margin-right: 6px;">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                </svg>
                                Payments Up to Date
                            </div>
                            <div style="margin-top: 1rem; color: #718096; font-size: 0.9rem;">
                                <p *ngIf="profile.lastPaidDate"><strong>Last Rent Paid On:</strong>
                                    {{profile.lastPaidDate | date:'mediumDate'}}</p>
                                <p *ngIf="!profile.isInNoticePeriod"><strong>Next Rent Due:</strong>
                                    {{profile.rentDueDate | date:'mediumDate'}}</p>
                                <p *ngIf="profile.isInNoticePeriod"><strong>Days Left for Exit:</strong> {{
                                    getDaysLeftForExit() }} Days</p>
                            </div>
                        </div>
                    </div>




                    <div class="detail-section" *ngIf="profile.rentType !== 'Daily'">

                        <h3>Notice Period</h3>

                        <!-- Not in notice period and no pending request -->
                        <div *ngIf="!profile.isInNoticePeriod && profile.noticeStatus !== 'Pending'">
                            <p>Planning to move out? You need to initiate a 30-day notice period.</p>
                            <button class="notice-btn" (click)="initiateNotice()">Initiate Notice Period</button>
                        </div>

                        <!-- Pending Request -->
                        <div *ngIf="profile.noticeStatus === 'Pending'" class="notice-pending"
                            style="background: #fffaf0; border: 1px solid #fbd38d; padding: 1rem; border-radius: 8px;">
                            <p style="color: #c05621; font-weight: 600; margin-bottom: 0.5rem;">Notice Request Sent
                            </p>
                            <p style="font-size: 0.9rem; color: #744210;">Your request is awaiting admin approval.
                                You will remain in regular status until approved.</p>
                        </div>

                        <!-- Approved / In Notice Period -->
                        <div *ngIf="profile.isInNoticePeriod" class="notice-active">
                            <p><strong>Start Date:</strong> {{profile.noticeStartDate | date}}</p>
                            <p><strong>Move Out Date:</strong> {{profile.rentDueDate | date}}</p>
                            <p><strong>Refundable Advance:</strong> ₹{{profile.advanceAmount - 1000}} (after
                                maintenance)
                            </p>
                            <div class="status-badge status-notice">Under Notice</div>
                        </div>
                    </div>




                    <div class="detail-section" *ngIf="profile.rentType === 'Daily'">
                        <h3>Payment</h3>
                        <div *ngIf="profile.paymentStatus !== 'Paid'">
                            <p><strong>Total Payable:</strong> ₹{{profile.rentAmount}}</p>
                            <button class="action-btn" (click)="payRent()" style="margin-top: 1rem;">Pay
                                Now</button>
                        </div>
                        <div *ngIf="profile.paymentStatus === 'Paid'">
                            <div class="status-badge"
                                style="background: #f0fff4; color: #38a169; border: 1px solid #c6f6d5;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                    style="width: 16px; margin-right: 6px;">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                </svg>
                                Payment Done
                            </div>
                            <p style="margin-top: 1rem; color: #718096; font-size: 0.9rem;">
                                <strong>Paid On:</strong> {{profile.lastPaidDate | date:'mediumDate'}}
                            </p>
                        </div>
                    </div>



                </div>
            </div>

            <div *ngIf="activeTab === 'transactions'">
                <div class="header-action">
                    <h2>Payment History</h2>
                </div>
                <div class="list">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Payment ID</th>
                                <th>Amount</th>
                                <th>Type</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let t of transactions" class="fade-in-row">
                                <td>{{t.paymentDate | date:'medium'}}</td>
                                <td style="font-family: monospace;">{{t.paymentId}}</td>
                                <td style="font-weight: 600;">₹{{t.amount}}</td>
                                <td>{{t.type}}</td>
                                <td>
                                    <span class="status-badge"
                                        style="background: #f0fff4; color: #38a169; border: 1px solid #c6f6d5;">
                                        {{t.status}}
                                    </span>
                                </td>
                            </tr>
                            <tr *ngIf="transactions.length === 0">
                                <td colspan="5" style="text-align: center; padding: 3rem; color: #718096;">
                                    No transactions found.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>


        <!-- Notice Confirmation Modal -->
        <div class="modal-overlay" *ngIf="showNoticeConfirmationModal">
            <div class="modal-content" style="max-width: 400px; text-align: center;">
                <div style="margin-bottom: 1.5rem;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#e53e3e" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" style="width: 48px; height: 48px; margin-bottom: 1rem;">
                        <path
                            d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z">
                        </path>
                        <line x1="12" y1="9" x2="12" y2="13"></line>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                    <h3 style="color: #2d3748; margin-bottom: 0.5rem;">Initiate Notice?</h3>
                    <p style="color: #4a5568;">Are you sure you want to initiate a notice period? </p>
                    <p style="color: #718096; font-size: 0.85rem; margin-top: 0.5rem;">This action cannot be undone.</p>
                </div>
                <div class="modal-actions" style="justify-content: center; gap: 1rem; display: flex;">
                    <button class="close-btn" (click)="closeNoticeConfirmation()"
                        style="width: auto; padding: 10px 24px; margin: 0;">Cancel</button>
                    <button class="action-btn" (click)="confirmNoticeInitiation()"
                        style="background: #e53e3e; border: none; width: auto; padding: 10px 24px; box-shadow: 0 4px 12px rgba(229, 62, 62, 0.3);">Yes,
                        Initiate</button>
                </div>
            </div>
        </div>

        <!-- Loading / Error Message -->
        <div *ngIf="!profile" class="empty-state">

            <div *ngIf="!errorMessage" class="loading-spinner">
                <div class="pulse"></div>
                <p>Loading Dashboard...</p>
            </div>
            <div *ngIf="errorMessage" class="error-card fade-in">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round" class="error-icon">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
                <h3>Oops! Something went wrong</h3>
                <p>{{ errorMessage }}</p>
                <button class="action-btn" (click)="loadProfile()" style="margin-top: 20px;">Try Refreshing</button>
            </div>
        </div>
    </main>
</div>